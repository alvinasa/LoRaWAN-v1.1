# 3 物理消息格式

LoRa术语区分上行链路和下行链路消息。

## 3.1 上行消息

**上行链路消息**由终端设备发送到网络服务器，通过一个或多个网关。

上行链路消息使用LoRa无线数据包显式模式，其中包含LoRa物理报头（**PHDR**）加上报头CRC（**PHDR\_CRC**）①。有效负载的完整性受CRC保护。

无线收发器插入**PHDR**，**PHDR\_CRC**和有效载荷**CRC**字段。

上行PHY：

| Preamble | PHDR | PHDR\_CRC | PHYPayload | CRC |
| :---: | :---: | :---: | :---: | :---: |


## 3.2 下行消息

每个**下行链路消息**由网络服务器仅发送到一个终端设备，并由单个网关中继②。

下行链路消息使用包含LoRa物理报头（**PHDR**）和报头CRC（**PHDR\_CRC**）的无线数据包显式模式③。

上行PHY：

| Preamble | PHDR | PHDR\_CRC | PHYPayload |
| :---: | :--- | :--- | :--- |


①有关LoRa无线数据包隐式/显式模式的说明，请参阅LoRa无线收发器数据表。

②本规范没有描述从网络服务器到多个终端设备的多播消息传输。

③在此级别不进行有效负载完整性检查，以尽可能缩短消息，同时对所使用的ISM频段的任何占空比限制影响最小。

## 3.3 接收窗口

在每次上行传输之后，终端设备必须打开两个短接收窗口。

接收窗口的开始时间是以传输结束为参考定义的。

![](.gitbook/assets/figure-4-end-device-receive-slot-timing.png)

### 3.3.1 第一接收窗口信道，数据速率和启动

第一接收窗口RX1使用的频率是上行链路频率的一个函数，使用的数据速率是上行链路数据速率的一个函数。RX1在上行链路调制结束后打开RECEIVE\_DELAY1①秒（+/- 20微秒）。上行链路和RX1时隙下行链路数据速率之间的关系是区域特定的，并在\[PHY\]中详细说明。默认情况下，第一个接收窗口数据速率与最后一个上行链路的数据速率相同。

### 3.3.2 第二接收窗口信道，数据速率和启动

第二接收窗口RX2使用固定的可配置频率和数据速率，并在上行链路调制结束后打开RECEIVE\_DELAY2①秒（+/- 20微秒）。使用的频率和数据速率可以通过MAC命令修改（参见第5节）。使用的默认频率和数据速率是区域特定的，并在\[PHY\]中详细说明。

### 3.3.3 接收窗口时长

接收窗口的长度必须至少是终端设备无线收发器有效地检测下行链路前导码所需的时间。

### 3.3.4 接收窗口期间的接收方行为

如果在一个接收窗口期间检测到前导码，则无线接收器保持活动状态，直到下行链路帧被解调。如果在第一个接收窗口期间检测到帧并随后进行解调，在地址和MIC（消息完整性代码）校验之后将帧用于该终端设备，则终端设备务必不打开第二个接收窗口。

### 3.3.5 网络发送消息到终端设备

如果网络想要向终端设备发送下行链路，它必须正好在两个接收窗口中的至少一个的开始处启动传输。如果在两个窗口期间发送下行链路，则必须在每个窗口期间发送相同的帧。

### 3.3.6 关于接收窗口的重要注意

终端设备在其先前传输的第一个或第二个接收窗口中收到下行链路消息，或者先前传输的第二个接收窗口过期之前，不会传输另一个上行链路消息。

### 3.3.7 接收或传输其他协议

只要终端设备与当地法规兼容并符合LoRaWAN规范，节点可以监听或传输其他协议，或在LoRaWAN传输和接收窗口之间进行任何无线交易。

①第6章介绍了RECEIVE\_DELAY1和RECEIVE\_DELAY2。

