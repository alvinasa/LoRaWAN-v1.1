# 15.1 信标物理层

除了在终端设备和网络服务器之间中继消息之外，网关还可以通过以定期的固定间隔发送信标来参与提供时间同步机制。所有信标都以无线数据包隐式模式传输，即没有LoRa物理数据头并且无线收发器没有附加CRC。

| PHY | Preamble | BCNPayload |
| :---: | :---: | :---: |


信标前导码应以（比默认值长的）10个未调制符号开始。这使得终端设备可以实现低功耗的循环式信标搜索。

信标帧长度紧密耦合到无线物理层的操作。因此实际的帧长度和内容可能会从一个区域实现变为另一个。在\[PHY\]中为每个区域指定使用的信标内容，调制参数和频率。

# 15.2 信标帧内容

信标有效载荷**BCNPayload**由网络公共部分和网关特定部分组成。

| Size（bytes） | 2/3 | 4 | 2 | 7 | 0/1 | 2 |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| BCNPayload | RFU | Time | CRC | GwSpecific | RFU | CRC |

公共部分包含等于0的RFU字段，时间戳记自1980年1月6日星期日00:00:00（GPS历元开始）模2^32，以秒为单位的**时间**。信标网络公共部分的完整性受到16位CRC的保护。根据IEEE 802.15.4-2003第7.2.1.8节中定义的RFU + 时间字段计算CRC-16。该CRC使用以下多项式**P\(x\) = x^16 + x^12 + x^5 + x^0**。CRC是按照它们通过空中发送的顺序计算的。

例如：这是一个有效的EU868信标帧：

00 00 \| 00 00 02 CC \| A2 7E \| 00 \| 01 20 00 \| 00 81 03 \| DE 55

字节从左向右传输。第一个CRC是在\[00 00 00 00 02 CC\]上计算的。相应的字段值是：

| Field | RFU | Time | CRC | InfoDesc | lat | long | CRC |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| Value Hex | 0000 | CC020000 | 7EA2 | 0 | 002001 | 038100 | 55DE |

特定于网关的部分提供关于发送信标的网关的附加信息，因此对于每个网关可能不同。适当时的RFU字段（区域特定）应该等于0。可选部分受在GwSpecific + RFU字段上计算的CRC-16保护。CRC-16定义与强制性部分相同。

例如：这是一个有效的US900信标：

| Field | RFU | Time | CRC | InfoDesc | lat | long | RFU | CRC |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| Value Hex | 000000 | CC020000 | 7E A2 | 00 | 002001 | 038100 | 00 | D450 |

在空中，字节按以下顺序发送：

00 00 00 \| 00 00 02 CC \| A2 7E \| 00 \| 01 20 00 \| 00 81 03 \|00 \| 50 D4

监听并同步到网络公共部分足以操作B类模式下的固定终端设备。移动终端设备也可以解调信标的网关特定部分，以便每当他从一个小区移动到另一个小区时能够向网络服务器发信号。

> 注意：如前所述，参与信标过程的所有网关同时发送它们的信标，以使对于网络公共部分，即使终端设备同时从多个网关接收信标，监听终端设备也没有可见的空中冲突。并非所有的网关都需要参与信标过程。网关对特定信标的参与可能是随机的。关于网关特定部分，发生冲突，但多个网关附近的终端设备仍然能够以高概率解码最强的信标。

# 15.3 信标_GwSpecific_字段格式

**GwSpecific**字段的内容如下：

| Size（bytes） | 1 | 6 |
| :---: | :---: | :---: |
| GwSpecific | InfoDesc | Info |

信息描述符**InfoDesc**描述如何解释信息字段**Info**。

| InfoDesc | Meaning |
| :---: | :---: |
| 0 | 网关第一个天线的GPS坐标 |
| 1 | 网关第二个天线的GPS坐标 |
| 2 | 网关第三个天线的GPS坐标 |
| 3:127 | RFU |
| 128:255 | 保留用于自定义网络特定广播 |

对于单个全向天线网关，在广播GPS坐标时，**InfoDesc**值为0。例如，对于以3个扇形天线为特征的站点，第一个天线广播**InfoDesc**等于0的信标，**InfoDesc**字段等于1的第二个天线等。

## 15.3.1 网关GPS坐标：InfoDesc = 0, 1或2

对于**InfoDesc** = 0, 1或2，**Info**字段的内容编码广播信标的天线的GPS坐标。

| Size（bytes） | 3 | 3 |
| :---: | :---: | :---: |
| Info | Lat | Lng |

纬度和经度字段（分别为**Lat**和**Lng**）按如下方式对网关的地理位置进行编码：

* 南北纬度采用二进制补码24位字编码，其中-2^23对应于南极90°（南极），2^23-1对应于北极（北极）〜90°。赤道对应于0。
* 东西经度采用二进制补码24位字编码，其中-2^23对应于180°西，2^23-1对应于〜180°东。格林威治子午线对应于0。

# 15.4 信标准确定时

从1980年1月5日星期日至1月6日星期日00:00:00（GPS历元开始）加上TBeaconDelay，每隔128秒发送一次信标。因此信标在GPS历元

BT = _k_ \* 128 + TBeaconDelay

秒后发送。

由此_k_是其中的最小整数

_k_ \* 128 &gt; _T_

因此T = 1980年1月5日星期日00:00:00（GPS时间开始）以来的秒数。

> 注意：T是GPS时间，与Unix时间不同，T严格单调递增，不受闰秒的影响。

因此TBeaconDelay的延迟为1.5毫秒+/- 1微秒。

TBeaconDelay旨在允许无线电系统从接收切换到发送模式所需的网关的轻微传输延迟。

所有终端设备ping时隙都使用信标传输开始时间作为定时参考，因此网络服务器在调度B类下行链路时将考虑TBeaconDelay。

# 15.5 网络下行路由更新要求

当网络尝试使用B类下行链路时隙与终端设备进行通信时，它会在接收到最后一个上行链路时从最靠近终端设备的网关传输下行链路。 因此，网络服务器需要跟踪每个B类设备的粗略位置。

无论何时B类设备移动并更改区，它都需要与网络服务器通信以更新其下行路由。这个更新可以简单地通过发送“确认”或“未确认”的上行链路来执行，可能没有适当的有效载荷。

终端设备有两种基本策略可供选择：

* 系统周期性上行链路：不需要解调信标的“网关特定”字段的最简单的方法。仅适用于缓慢移动或安置终端设备。这些周期性上行链路没有要求。
* 区切换时的上行链路：终端设备解调信标的“特定网关”字段，检测广播信标的网关ID其解调已经改变，并发送上行链路。在这种情况下，设备应遵守信标解调和上行链路传输之间的\[0:120\]秒范围内的伪随机延迟。这需要确保在相同信标周期内进入或离开区的多个B类设备的上行链路不会在信标广播之后立即同时系统地发生。

未能报告区的改变将导致B类下行链路暂时不工作。网络服务器可能不得不等待下一个终端设备上行链路来传输下行链路流量。





